
name: Grilo SC Analysis for Java (Maven/Gradle)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch: {}

jobs:
  sonar-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =========================================================================
      # SETUP DO AMBIENTE DE BUILD
      # =========================================================================
      - name: Setup Build Environment
        id: setup_env
        run: |
          echo "üîç Detectando sistema de build..."
          
          echo "üì± Verificando necessidade de google-services.json..."
          if grep -rq "com.google.gms.google-services" . 2>/dev/null || grep -rq "google-services" . 2>/dev/null; then
            echo "üî• Projeto usa Firebase/Google Services"
            for app_dir in $(find . -type d -name "app"); do
              if [ ! -f "$app_dir/google-services.json" ]; then
                echo "üìù Criando google-services.json dummy em: $app_dir"
                echo "ewogICJwcm9qZWN0X2luZm8iOiB7CiAgICAicHJvamVjdF9udW1iZXIiOiAiMDAwMDAwMDAwMDAwIiwKICAgICJwcm9qZWN0X2lkIjogImR1bW15LXByb2plY3QtZm9yLWNpIiwKICAgICJzdG9yYWdlX2J1Y2tldCI6ICJkdW1teS1wcm9qZWN0LWZvci1jaS5hcHBzcG90LmNvbSIKICB9LAogICJjbGllbnQiOiBbCiAgICB7CiAgICAgICJjbGllbnRfaW5mbyI6IHsKICAgICAgICAibW9iaWxlc2RrX2FwcF9pZCI6ICIxOjAwMDAwMDAwMDAwMDphbmRyb2lkOjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAiLAogICAgICAgICJhbmRyb2lkX2NsaWVudF9pbmZvIjogewogICAgICAgICAgInBhY2thZ2VfbmFtZSI6ICJjb20uZXhhbXBsZS5hcHAiCiAgICAgICAgfQogICAgICB9LAogICAgICAiYXBpX2tleSI6IFsKICAgICAgICB7CiAgICAgICAgICAiY3VycmVudF9rZXkiOiAiQUl6YVN5RHVtbXlLZXlGb3JDSUJ1aWxkT25seTAwMDAwMDAwMCIKICAgICAgICB9CiAgICAgIF0KICAgIH0KICBdLAogICJjb25maWd1cmF0aW9uX3ZlcnNpb24iOiAiMSIKfQo=" | base64 -d > "$app_dir/google-services.json"
              fi
            done
          fi
          
          # 1. MAVEN
          POM_PATH=$(find . -maxdepth 3 -name "pom.xml" -not -path "*/target/*" | head -n 1)
          if [ -n "$POM_PATH" ]; then
            echo "‚úÖ Maven detectado em: $POM_PATH"
            echo "build_system=maven" >> $GITHUB_OUTPUT
            echo "build_file=$POM_PATH" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2. GRADLE
          GRADLE_FILE=$(find . -maxdepth 3 \( -name "build.gradle" -o -name "build.gradle.kts" \) -type f | head -n 1)
          if [ -n "$GRADLE_FILE" ]; then
            echo "‚úÖ Gradle detectado em: $GRADLE_FILE"
            echo "build_system=gradle" >> $GITHUB_OUTPUT
            echo "build_file=$GRADLE_FILE" >> $GITHUB_OUTPUT
            
            PROPS=$(find . -name "gradle-wrapper.properties" -type f | head -n 1)
            TARGET_VERSION="8.10.2"
            
            if [ -f "$PROPS" ]; then
               ver=$(grep -oE 'gradle-[0-9.]+(-(bin|all))?\.zip' "$PROPS" | grep -oE '[0-9]+\.[0-9]+(\.[0-9]+)?' | head -n 1)
               if [ -n "$ver" ]; then
                 TARGET_VERSION="$ver"
                 echo "‚úÖ Vers√£o detectada no projeto: $TARGET_VERSION"
               else
                 echo "‚ö†Ô∏è Vers√£o n√£o detectada, usando fallback: $TARGET_VERSION"
               fi
            fi
            echo "detected_gradle_ver=$TARGET_VERSION" >> $GITHUB_OUTPUT
            
            echo "‚¨áÔ∏è Baixando Gradle $TARGET_VERSION..."
            wget -q "https://services.gradle.org/distributions/gradle-${TARGET_VERSION}-bin.zip" || {
              echo "‚ùå Falha ao baixar Gradle"
              exit 0
            }
            unzip -q "gradle-${TARGET_VERSION}-bin.zip"
            echo "GRADLE_HOME=$PWD/gradle-${TARGET_VERSION}/bin" >> $GITHUB_ENV
            echo "$PWD/gradle-${TARGET_VERSION}/bin" >> $GITHUB_PATH
            echo "‚úÖ Gradle $TARGET_VERSION instalado"
          else
             echo "‚ö†Ô∏è Nenhum build system detectado"
             echo "build_system=unknown" >> $GITHUB_OUTPUT
          fi

      # =========================================================================
      # DETEC√á√ÉO INTELIGENTE DA VERS√ÉO DO JAVA
      # =========================================================================
      - name: Detect Java Version
        id: detect_java
        shell: bash
        run: |
          DETECTED_JAVA="21"
          echo "üîç Analisando vers√£o do Java requerida..."
          
          if [ "${{ steps.setup_env.outputs.build_system }}" == "maven" ]; then
             POM="${{ steps.setup_env.outputs.build_file }}"
             if [ -f "$POM" ]; then
               RAW_VERSION=$(grep -E '<(java\.version|maven\.compiler\.(source|target|release))>' "$POM" | head -n 1 | awk -F'[><]' '{print $3}')
               if [ -n "$RAW_VERSION" ]; then
                 if [[ "$RAW_VERSION" == 1.* ]]; then DETECTED_JAVA=$(echo "$RAW_VERSION" | cut -d. -f2); else DETECTED_JAVA="$RAW_VERSION"; fi
                 echo "‚úÖ Vers√£o Java detectada no Maven: $DETECTED_JAVA"
               fi
             fi
          fi
          
          if [ "${{ steps.setup_env.outputs.build_system }}" == "gradle" ]; then
             GRADLE="${{ steps.setup_env.outputs.build_file }}"
             if [ -f "$GRADLE" ]; then
                RAW_VERSION=$(grep -oE '(JavaLanguageVersion\.of\([0-9]+\)|sourceCompatibility\s*=\s*[\"'\'']?[0-9.]+[\"'\'']?)' "$GRADLE" | grep -oE '[0-9]+(\.[0-9]+)*' | head -n 1)
                if [ -n "$RAW_VERSION" ]; then
                   if [[ "$RAW_VERSION" == 1.* ]]; then DETECTED_JAVA=$(echo "$RAW_VERSION" | cut -d. -f2); else DETECTED_JAVA="$RAW_VERSION"; fi
                   echo "‚úÖ Vers√£o Java detectada no Gradle: $DETECTED_JAVA"
                fi
             fi
          fi
          
          echo "üèÅ Usando Java: $DETECTED_JAVA"
          echo "java_version=$DETECTED_JAVA" >> $GITHUB_OUTPUT

      # =========================================================================
      # SETUP JAVA
      # =========================================================================
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ steps.detect_java.outputs.java_version }}
          distribution: 'temurin'

      # =========================================================================
      # MAVEN: Compila e analisa
      # =========================================================================
      - name: Maven Build and Analysis
        id: maven_build
        if: steps.setup_env.outputs.build_system == 'maven'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dmaven.test.skip=true \
            -f ${{ steps.setup_env.outputs.build_file }} \
            -Dsonar.projectKey=grilo-org_20260220T141048_LeonardoRSantos_tenda-atacado-cupom \
            -Dsonar.projectName=20260220T141048_LeonardoRSantos_tenda-atacado-cupom \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.organization=grilo-org; then
              echo "‚úÖ Build Maven conclu√≠do."
              echo "build_success=true" >> $GITHUB_OUTPUT
          else
              echo "‚ö†Ô∏è Build Maven falhou, tentando an√°lise source-only..."
              echo "build_success=false" >> $GITHUB_OUTPUT
          fi

      # =========================================================================
      # GRADLE: Tenta compilar e localiza bin√°rios dinamicamente
      # =========================================================================
      - name: Gradle Build (Best Effort)
        if: steps.setup_env.outputs.build_system == 'gradle'
        id: gradle_build
        continue-on-error: true
        run: |
          BUILD_DIR=$(dirname "${{ steps.setup_env.outputs.build_file }}")
          cd "$BUILD_DIR"
          
          echo "üöÄ Tentando compilar com Gradle..."
          BUILD_SUCCESS="false"
          
          if gradle compileDebugSources -x test -x lint --no-daemon -Dorg.gradle.java.home=$JAVA_HOME 2>/dev/null; then
            BUILD_SUCCESS="true"
          elif gradle compileKotlin -x test --no-daemon -Dorg.gradle.java.home=$JAVA_HOME 2>/dev/null; then
            BUILD_SUCCESS="true"
          elif gradle compileJava -x test --no-daemon -Dorg.gradle.java.home=$JAVA_HOME 2>/dev/null; then
            BUILD_SUCCESS="true"
          elif gradle classes -x test --no-daemon -Dorg.gradle.java.home=$JAVA_HOME 2>/dev/null; then
            BUILD_SUCCESS="true"
          else
            echo "‚ö†Ô∏è Build falhou, mas continuando."
          fi
          
          echo "build_success=$BUILD_SUCCESS" >> $GITHUB_OUTPUT
          
          # -----------------------------------------------------------------
          # CORRE√á√ÉO v8: Localizar dinamicamente os bin√°rios gerados
          # Evita o erro "No files nor directories matching '**/build/classes'"
          # -----------------------------------------------------------------
          if [ "$BUILD_SUCCESS" == "true" ]; then
             echo "üîç Procurando diret√≥rios com arquivos .class gerados..."
             BIN_DIRS=$(find . -name "*.class" -type f -exec dirname {} + | sort -u | paste -sd "," -)
             
             if [ -z "$BIN_DIRS" ]; then
                echo "‚ö†Ô∏è Nenhum .class encontrado na busca. Usando diret√≥rio fallback."
                mkdir -p build/dummy_classes
                BIN_DIRS="build/dummy_classes"
             fi
             
             echo "bin_dirs=$BIN_DIRS" >> $GITHUB_OUTPUT
             echo "‚úÖ Diret√≥rios de bin√°rios mapeados: $BIN_DIRS"
          fi

      # =========================================================================
      # SONARCLOUD SCAN (Gradle com bin√°rios - apenas se build teve sucesso)
      # =========================================================================
      - name: SonarCloud Scan (Gradle with Binaries)
        if: steps.setup_env.outputs.build_system == 'gradle' && steps.gradle_build.outputs.build_success == 'true'
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=grilo-org_20260220T141048_LeonardoRSantos_tenda-atacado-cupom
            -Dsonar.projectName=20260220T141048_LeonardoRSantos_tenda-atacado-cupom
            -Dsonar.organization=grilo-org
            -Dsonar.java.binaries=${{ steps.gradle_build.outputs.bin_dirs }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/*.class,**/build/**,**/gradle/**,**/target/**,.gradle/**

      # =========================================================================
      # SONARCLOUD SCAN (Gradle Source-Only - fallback quando build falha)
      # =========================================================================
      - name: SonarCloud Scan (Gradle Source Only)
        if: steps.setup_env.outputs.build_system == 'gradle' && steps.gradle_build.outputs.build_success != 'true'
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=grilo-org_20260220T141048_LeonardoRSantos_tenda-atacado-cupom
            -Dsonar.projectName=20260220T141048_LeonardoRSantos_tenda-atacado-cupom
            -Dsonar.organization=grilo-org
            -Dsonar.sources=.
            -Dsonar.exclusions=**/*.class,**/build/**,**/gradle/**,**/target/**,.gradle/**

      # =========================================================================
      # AN√ÅLISE SOURCE-ONLY (fallback para build system desconhecido)
      # =========================================================================
      - name: SonarCloud Scan (Source Only)
        if: steps.setup_env.outputs.build_system == 'unknown'
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=grilo-org_20260220T141048_LeonardoRSantos_tenda-atacado-cupom
            -Dsonar.projectName=20260220T141048_LeonardoRSantos_tenda-atacado-cupom
            -Dsonar.organization=grilo-org
            -Dsonar.sources=.

      # =========================================================================
      # RELAT√ìRIO FINAL
      # =========================================================================
      - name: Analysis Summary
        if: always()
        run: |
          echo "============================================================"
          echo "üìä RESUMO DA AN√ÅLISE SONARCLOUD"
          echo "============================================================"
          echo ""
          echo "Projeto: 20260220T141048_LeonardoRSantos_tenda-atacado-cupom"
          echo "Build System: ${{ steps.setup_env.outputs.build_system }}"
          echo "Java Version: ${{ steps.detect_java.outputs.java_version }}"
          echo ""
          # Verifica se Maven OU Gradle tiveram sucesso
          if [ "${{ steps.maven_build.outputs.build_success }}" == "true" ] || [ "${{ steps.gradle_build.outputs.build_success }}" == "true" ]; then
            echo "‚úÖ Build: SUCESSO"
            echo "   An√°lise completa com bin√°rios dispon√≠veis."
          else
            echo "‚ö†Ô∏è Build: FALHOU ou N√ÉO EXECUTADO (Fallback Source-Only)"
            echo "   Algumas m√©tricas podem estar incompletas."
          fi
          echo ""
          echo "Dashboard: https://sonarcloud.io/dashboard?id=grilo-org_20260220T141048_LeonardoRSantos_tenda-atacado-cupom"
          echo "============================================================"
